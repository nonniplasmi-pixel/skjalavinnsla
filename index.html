<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kauptilboð – OCR demo + beiðnir (Single File)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- docx.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.3.2/docx.min.js"></script>

  <style>
    body { background: #0b1220; color: #E5E7EB; }
    .card { background: #111827; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.35); }
    .badge { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 0.5rem; }
    .ok { background: #065f46; } .warn { background: #92400e; } .err { background: #7f1d1d; }
    .muted { color: #9CA3AF; }
    textarea, input { background:#0f172a; border:1px solid #334155; border-radius:0.5rem; padding:0.5rem; color:#E5E7EB; width:100%; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; background:#0a0f1d; border:1px solid #1f2937; border-radius:0.5rem; padding:0.75rem; white-space:pre-wrap; }
    .btn { padding: 0.6rem 1rem; border-radius: 0.75rem; }
    progress { width: 100%; height: 10px; }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-6xl mx-auto space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-bold text-white">
        Prufuupphleðsla kauptilboðs (PDF → texti, OCR fallback)
        <span class="ml-2 text-xs px-2 py-1 rounded bg-indigo-600 align-middle">LIVE</span>
      </h1>
      <div class="text-sm muted">Single-file demo • Engin gögn send út</div>
    </header>

    <!-- UPLOAD -->
    <section class="card p-4 md:p-6">
      <div class="grid md:grid-cols-2 gap-4 items-start">
        <div>
          <label class="block mb-2">Hlaða upp kauptilboði (PDF)</label>
          <input id="file" type="file" accept="application/pdf" />
          <p class="muted mt-2 text-sm">Ef PDF er skannað (mynd), notar kerfið sjálfkrafa OCR.</p>
          <div id="ocrState" class="mt-3 hidden">
            <div class="text-blue-300 mb-1 text-sm">OCR í gangi – getur tekið nokkrar sekúndur.</div>
            <progress id="ocrProgress" value="0" max="100"></progress>
            <div id="ocrMsg" class="muted text-xs mt-1"></div>
          </div>
        </div>
        <div>
          <div class="text-sm text-blue-300 mb-2">Hraðsamantekt</div>
          <div id="summary" class="code text-sm">Engin gögn enn. Hladdu upp PDF eða límdu texta hér að neðan.</div>
        </div>
      </div>
    </section>

    <!-- RAW TEXT -->
    <section class="card p-4 md:p-6">
      <div class="text-sm text-blue-300 mb-2">Unninn texti (úr PDF eða handvirkt límt)</div>
      <textarea id="raw" rows="10" placeholder="Límdu texta úr kauptilboði ef þú vilt prófa án PDF..."></textarea>
      <div class="mt-3 flex gap-2">
        <button id="parseBtn" class="btn bg-blue-600 hover:bg-blue-500">Greina texta</button>
        <button id="clearBtn" class="btn bg-gray-700 hover:bg-gray-600">Hreinsa</button>
      </div>
    </section>

    <!-- FIELDS -->
    <section class="card p-4 md:p-6">
      <div class="text-sm text-blue-300 mb-2">Greindir reitir (má breyta handvirkt)</div>
      <div class="grid-2">
        <div><label>Seljandi – nafn</label><input id="sellerName" /></div>
        <div><label>Seljandi – kennitala</label><input id="sellerSSN" /></div>
        <div><label>Kaupandi – nafn</label><input id="buyerName" /></div>
        <div><label>Kaupandi – kennitala</label><input id="buyerSSN" /></div>
        <div><label>Eign – heimilisfang</label><input id="propertyAddress" /></div>
        <div><label>Fasteignanúmer / landnúmer</label><input id="propertyId" /></div>
        <div><label>Kaupverð (ISK)</label><input id="price" /></div>
        <div><label>Trygging / útborgun (ISK)</label><input id="deposit" /></div>
        <div><label>Afhendingardagur</label><input id="handover" /></div>
        <div><label>Fyrirvarar / sérákvæði</label><input id="conditions" /></div>
        <div><label>Útgáfudagur afsals</label><input id="deedIssueDate" /></div>
        <div><label>Fyrirvarar seljanda</label><input id="sellerContingencies" /></div>
        <div><label>Fyrirvarar kaupanda</label><input id="buyerContingencies" /></div>
      </div>

      <div class="mt-4 grid md:grid-cols-3 gap-3">
        <button id="btnVedleyfi" class="btn bg-yellow-600 hover:bg-yellow-500">Sækja um skilyrt veðleyfi (DOCX)</button>
        <button id="btnVedflutningur" class="btn bg-emerald-600 hover:bg-emerald-500">Útbúa veðflutningsbeiðni (DOCX)</button>
        <button id="btnLanaskjol" class="btn bg-indigo-600 hover:bg-indigo-500">Biðja um lánaskjöl (Email draft)</button>
      </div>

      <div class="mt-3 flex flex-wrap gap-3">
        <label class="badge warn"><input id="hasLoan" type="checkbox"> Eign með láni</label>
        <label class="badge warn"><input id="hasChain" type="checkbox"> 2+ eignir í keðju</label>
        <label class="badge warn"><input id="hasLandLease" type="checkbox"> Lóðarleiga</label>
      </div>
    </section>

    <!-- CHECKLIST -->
    <section class="card p-4 md:p-6">
      <div class="text-sm text-blue-300 mb-2">Gátlisti – hvað vantar?</div>
      <div id="checklist" class="space-y-2 text-sm"></div>
      <div class="mt-3">
        <button id="refreshChecklist" class="btn bg-emerald-600 hover:bg-emerald-500">Endurreikna gátlista</button>
      </div>
    </section>

    <!-- JSON OUT -->
    <section class="card p-4 md:p-6">
      <div class="text-sm text-blue-300 mb-2">JSON‑útflutningur</div>
      <div class="grid-2">
        <textarea id="jsonOut" rows="12" class="code"></textarea>
        <div>
          <div class="muted mb-2">Afrita niðurstöður</div>
          <button id="copyJson" class="btn bg-indigo-600 hover:bg-indigo-500">Afrita JSON</button>
        </div>
      </div>
    </section>

    <footer class="text-xs muted text-center py-6">© Prufa – Skjalavinnslukerfi fasteignasala</footer>
  </div>

  <script>
  window.addEventListener('load', () => {
    try {
      if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
      }
    } catch (e) {}

    const $ = (id) => document.getElementById(id);
    const setValue = (id, v) => $(id).value = v || "";
    const getValue = (id) => (($(id).value) || "").trim();

    function refreshSummary(p) {
      const s = $('summary');
      s.textContent = [
        p.sellerName ? `Seljandi: ${p.sellerName}` : "Seljandi: ?",
        p.buyerName  ? `Kaupandi: ${p.buyerName}`  : "Kaupandi: ?",
        p.address    ? `Eign: ${p.address}` : "Eign: ?",
        p.price      ? `Kaupverð: ${p.price}` : "Kaupverð: ?",
      ].join("\n");
    }

    function checklist() {
      const items = [];
      if (!getValue('sellerName') || !getValue('sellerSSN')) items.push({t:"Vantar fullar upplýsingar um seljanda (nafn/kt.)", s:"err"});
      if (!getValue('buyerName') || !getValue('buyerSSN'))   items.push({t:"Vantar fullar upplýsingar um kaupanda (nafn/kt.)", s:"err"});
      if (!getValue('propertyAddress')) items.push({t:"Vantar heimilisfang eignar", s:"err"});
      if (!getValue('price')) items.push({t:"Vantar kaupverð", s:"err"});
      if (!getValue('handover')) items.push({t:"Vantar afhendingardag", s:"warn"});

      const hasLoan = $('hasLoan').checked, hasChain = $('hasChain').checked, hasLandLease = $('hasLandLease').checked;
      if (hasLoan)      items.push({t:"Lán á eign: biðja um lánayfirlit, veðbókarvottorð og uppgreiðsluáætlun", s:"warn"});
      if (hasChain)     items.push({t:"Tvær eða fleiri eignir: velja veðflutning eða uppgreiðslu á hverri eign", s:"warn"});
      if (hasLandLease) items.push({t:"Lóðarleiga: hlaða inn lóðarleigusamningi og skuldleysisstaðfestingu leigusala", s:"warn"});

      const cond = getValue('conditions').toLowerCase();
      if (cond.includes('veð') || cond.includes('ved')) items.push({t:"Skilyrt veðleyfi nefnt: stofna veðleyfis-/veðflutningsbeiðni og stöðva útgreiðslur þar til samþykkt liggur fyrir", s:"warn"});
      if (cond.includes('fjármögn') || cond.includes('fjarmogn')) items.push({t:"Fjármögnunar-fyrirvari: merkja sem skilyrði og fylgja gildistíma", s:"warn"});
      if (cond.includes('skoðun')) items.push({t:"Skoðunarfyrirvari: skrá frest og verklag við úrbætur/niðurlagningu", s:"ok"});

      const el = $('checklist'); el.innerHTML = "";
      if (items.length === 0) el.innerHTML = '<div class="badge ok inline-block">[OK] Engar athugasemdir</div>';
      else items.forEach(it => { const d = document.createElement('div'); d.className = `badge inline-block ${it.s}`; d.textContent = it.t; el.appendChild(d); });

      const json = {
        parties: {
          seller: { name: getValue('sellerName'), ssn: getValue('sellerSSN') },
          buyer:  { name: getValue('buyerName'),  ssn: getValue('buyerSSN') }
        },
        property: { address: getValue('propertyAddress'), id: getValue('propertyId') },
        price: { total: getValue('price'), deposit: getValue('deposit') },
        dates: { handover: getValue('handover'), deed_issue: getValue('deedIssueDate') },
        flags: { hasLoan, hasChain, hasLandLease },
        contingencies: {
          seller: getValue('sellerContingencies'),
          buyer:  getValue('buyerContingencies'),
          combined: getValue('conditions')
        },
        checklist: items.map(i => i.t)
      };
      $('jsonOut').value = JSON.stringify(json, null, 2);
    }

    function parseFields(rawText) {
      const txt = (rawText || "")
        .replace(/\r/g, "")
        .replace(/[ \t]+\n/g, "\n")
        .replace(/\u00A0/g, " ")
        .trim();

      const lines = txt.split(/\n+/);

      function nextLineAfter(labelRegex) {
        for (let i = 0; i < lines.length; i++) {
          if (labelRegex.test(lines[i])) {
            const sameLine = lines[i].replace(/\s+/g, " ").trim();
            const mSame = sameLine.match(/:\s*(.+)$/);
            if (mSame && mSame[1]) return mSame[1].trim();
            for (let j = i + 1; j < lines.length; j++) {
              const val = lines[j].trim();
              if (val) return val;
            }
          }
        }
        return "";
      }

      function sectionAfter(labelRegex, maxLines = 12) {
        for (let i = 0; i < lines.length; i++) {
          if (labelRegex.test(lines[i])) {
            const out = [];
            for (let j = i + 1; j < Math.min(lines.length, i + 1 + maxLines); j++) {
              const val = lines[j].trim();
              if (!val) break;
              out.push(val);
            }
            return out.join("\n");
          }
        }
        return "";
      }

      function splitNameAndSSN(line) {
        const ssnMatch = line.match(/\b(\d{6}[- ]?\d{4})\b/);
        const ssn = ssnMatch ? ssnMatch[1].replace(" ", "-") : "";
        const name = ssnMatch ? line.slice(0, ssnMatch.index).trim() : line.trim();
        return { name: name.replace(/[,\s]+$/,""), ssn };
      }

      let sellerLine = nextLineAfter(/^\s*Seljandi(\s+Kennitala.*)?\s*$/i);
      let seller = splitNameAndSSN(sellerLine);

      let buyerLine = nextLineAfter(/^\s*Kaupandi(\s+Kennitala.*)?\s*$/i);
      let buyer = splitNameAndSSN(buyerLine);
      const buyerIdx = lines.findIndex(l => /^\s*Kaupandi(\s+Kennitala.*)?\s*$/i.test(l));
      if (buyerIdx >= 0) {
        const maybeNames = (lines[buyerIdx+1] || "").replace(/\b\d{6}[- ]?\d{4}\b/g,"").replace(/\s{2,}/g," ").trim();
        if (maybeNames) buyerLine = maybeNames;
      }
      const buyerNames = buyerLine
        .replace(/\b\d{6}[- ]?\d{4}\b/g, "")
        .replace(/\s{2,}/g, " ")
        .replace(/[,\s]+$/,"")
        .trim();

      let priceLine = nextLineAfter(/Kaupver[ðd](\s+í\s+tölustöfum)?/i);
      let price = (priceLine.match(/[\d\. ]+(?:\s*kr\.?|\skr\.?)/i) || [""])[0]
        .replace(/\s+kr\.?/i, " kr.")
        .replace(/\s+/g, " ")
        .trim();

      let depositLine = nextLineAfter(/(Trygging|Útborgun)/i);
      let deposit = (depositLine.match(/[\d\. ]+(?:\s*kr\.?|\skr\.?)/i) || [""])[0]
        .replace(/\s+kr\.?/i, " kr.")
        .replace(/\s+/g, " ")
        .trim();

      let handover = nextLineAfter(/Afhending(ardagur)?/i) || nextLineAfter(/Afhending/i);

      let deedIssueDate = nextLineAfter(/Útgáfudagur\s+afsals/i);
      if (!deedIssueDate) {
        const payPlan = sectionAfter(/Greiðslutilhögun/i, 12);
        const m = payPlan.match(/(Afsal|útgáf[ua]\s+afsals).*?(\d{1,2}\.\d{1,2}\.\d{2,4}|[0-9]{4}-[0-9]{2}-[0-9]{2}|við\s+uppgjör|við\s+afsal)/i);
        deedIssueDate = m ? m[2] : "";
      }

      const sellerCont = nextLineAfter(/Fyrirvarar\s+seljanda/i) || "";
      const buyerCont  = nextLineAfter(/Fyrirvarar\s+kaupanda/i) || "";
      let conditionsBlock = nextLineAfter(/Fyrirvarar(\s*\/\s*sérákvæði)?/i) || nextLineAfter(/Sérákvæði/i) || "";

      let address = nextLineAfter(/^\s*Eign\s*$/i) || nextLineAfter(/Heimilisfang/i);
      let propId  = nextLineAfter(/fasteigna(nr\.|númer)|landnúmer/i);

      return {
        sellerName: seller.name, sellerSSN: seller.ssn,
        buyerName: buyerNames || buyer.name, buyerSSN: buyer.ssn,
        address, propId,
        price, deposit, handover,
        deedIssueDate,
        sellerContingencies: sellerCont,
        buyerContingencies:  buyerCont,
        conditions: conditionsBlock,
        raw: txt
      };
    }

    async function extractTextFromPDF_TextLayer(file) {
      if (!window.pdfjsLib) throw new Error("PDF.js hlaust ekki (pdfjsLib vantar).");
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let out = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        out += content.items.map(it => it.str).join(" ") + "\n";
      }
      console.log("PDF RAW TEXT (text-layer):", out);
      return out.trim();
    }

    async function extractTextFromPDF_OCR(file, progressCb) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let ocrText = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        const dataURL = canvas.toDataURL('image/png');
        const worker = await Tesseract.createWorker("eng+isl", 1);
        const { data } = await worker.recognize(dataURL);
        ocrText += data.text + "\n";
        await worker.terminate();
        if (progressCb) progressCb(i, pdf.numPages);
      }
      console.log("PDF RAW TEXT (ocr):", ocrText);
      return ocrText.trim();
    }

    async function extractSmart(file) {
      try {
        const textLayer = await extractTextFromPDF_TextLayer(file);
        if (textLayer && textLayer.split(/\s+/).length > 15) return { text: textLayer, method: "text-layer" };
      } catch (e) { /* fallback */ }
      const ocrBox = document.getElementById('ocrState'), ocrBar = document.getElementById('ocrProgress'), ocrMsg = document.getElementById('ocrMsg');
      ocrBox.classList.remove('hidden'); ocrBar.value = 0; if (ocrMsg) ocrMsg.textContent = "Byrja OCR...";
      const textOCR = await extractTextFromPDF_OCR(file, (i, n) => { ocrBar.value = Math.floor((i/n)*100); if (ocrMsg) ocrMsg.textContent = `OCR síða ${i}/${n}`; });
      ocrBar.value = 100; if (ocrMsg) ocrMsg.textContent = "OCR lokið";
      return { text: textOCR, method: "ocr" };
    }

    $('file').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        if (!window.pdfjsLib) throw new Error("PDF.js hlaust ekki (pdfjsLib is not defined).");
        const { text, method } = await extractSmart(file);
        $('raw').value = text || "";
        const p = parseFields(text || "");
        setValue('sellerName', p.sellerName); setValue('sellerSSN', p.sellerSSN);
        setValue('buyerName', p.buyerName);   setValue('buyerSSN', p.buyerSSN);
        setValue('propertyAddress', p.address); setValue('propertyId', p.propId);
        setValue('price', p.price); setValue('deposit', p.deposit);
        setValue('handover', p.handover); setValue('conditions', p.conditions);
        setValue('deedIssueDate', p.deedIssueDate);
        setValue('sellerContingencies', p.sellerContingencies);
        setValue('buyerContingencies', p.buyerContingencies);

        refreshSummary(p); checklist();
        $('summary').textContent += "\n\n[Aðferð] " + (method === "ocr" ? "OCR (Tesseract.js)" : "Textalag (PDF.js)");
      } catch (err) {
        $('summary').textContent = "Gat ekki lesið PDF: " + (err?.message || err);
      } finally {
        $('ocrState').classList.add('hidden');
      }
    });

    $('parseBtn').addEventListener('click', () => {
      const t = $('raw').value || "";
      const p = parseFields(t);
      setValue('sellerName', p.sellerName); setValue('sellerSSN', p.sellerSSN);
      setValue('buyerName', p.buyerName);   setValue('buyerSSN', p.buyerSSN);
      setValue('propertyAddress', p.address); setValue('propertyId', p.propId);
      setValue('price', p.price); setValue('deposit', p.deposit);
      setValue('handover', p.handover); setValue('conditions', p.conditions);
      setValue('deedIssueDate', p.deedIssueDate);
      setValue('sellerContingencies', p.sellerContingencies);
      setValue('buyerContingencies', p.buyerContingencies);
      refreshSummary(p); checklist();
    });

    document.querySelectorAll('input, textarea').forEach(el => el.addEventListener('input', checklist));
    document.getElementById('refreshChecklist')?.addEventListener('click', checklist);

    document.getElementById('copyJson')?.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(document.getElementById('jsonOut').value || ""); alert("JSON afritað!"); }
      catch { alert("Gat ekki afritað – veldu textann og afritaðu handvirkt."); }
    });

    // Email draft til banka
    document.getElementById('btnLanaskjol')?.addEventListener('click', () => {
      const bankEmail = "";
      const subj = encodeURIComponent("Beiðni um lánaskjöl og veðbókarvottorð");
      const body = encodeURIComponent(
`Sælir/sælar,

Ég óska eftir lánayfirliti, uppgreiðsluáætlun og veðbókarvottorði.

Eign: ${getValue('propertyAddress')} (FN: ${getValue('propertyId')})
Seljandi: ${getValue('sellerName')} kt. ${getValue('sellerSSN')}
Kaupandi: ${getValue('buyerName')} kt. ${getValue('buyerSSN')}
Kaupverð: ${getValue('price')}
Afhending: ${getValue('handover')}

Kv. [nafn fasteignasala]`);
      window.location.href = `mailto:${bankEmail}?subject=${subj}&body=${body}`;
    });

    // DOCX veðflutningsbeiðni
    document.getElementById('btnVedflutningur')?.addEventListener('click', async () => {
      const { Document, Packer, Paragraph, HeadingLevel, TextRun } = docx;
      const doc = new Document({
        sections: [{
          children: [
            new Paragraph({ text: "Veðflutningsbeiðni", heading: HeadingLevel.HEADING_1 }),
            new Paragraph(" "),
            new Paragraph(new TextRun({ text: "Eign:", bold: true })), new Paragraph(`${getValue('propertyAddress')} (FN: ${getValue('propertyId')})`),
            new Paragraph(" "), new Paragraph(new TextRun({ text: "Aðilar", bold: true })),
            new Paragraph(`Seljandi: ${getValue('sellerName')} kt. ${getValue('sellerSSN')}`),
            new Paragraph(`Kaupandi: ${getValue('buyerName')} kt. ${getValue('buyerSSN')}`),
            new Paragraph(" "), new Paragraph(new TextRun({ text: "Beiðni", bold: true })),
            new Paragraph("Óskað er eftir veðflutningi á eftirfarandi láni/veðrétti yfir á nýjan eiganda:"),
            new Paragraph("• Lán/veðréttur: ____________________________"),
            new Paragraph("• Veðröð: ____________   • Eftirstöðvar: ____________ kr."),
            new Paragraph("• Banki/lánastofnun: ________________________"),
            new Paragraph(" "), new Paragraph(new TextRun({ text: "Forsendur", bold: true })),
            new Paragraph(`Kaupverð: ${getValue('price')} – afhendingardagur: ${getValue('handover')}`),
            new Paragraph("Veðflutningur er skilyrtur því að greiðsluflæði og skilyrði samræmist lögskilauppgjöri."),
            new Paragraph(" "), new Paragraph(new TextRun({ text: "Staðfesting", bold: true })),
            new Paragraph("Staðfest er að ofangreindar upplýsingar eru réttar. Beiðnin er lögð fram af fasteignasala fyrir hönd aðila."),
            new Paragraph(" "), new Paragraph("___________________________    ___________________________"),
            new Paragraph("Dags.                                    Undirskrift"),
          ]
        }]
      });
      const blob = await Packer.toBlob(doc);
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob); a.download = "vedflutningsbeidni.docx"; a.click(); URL.revokeObjectURL(a.href);
    });

    // DOCX skilyrt veðleyfi
    document.getElementById('btnVedleyfi')?.addEventListener('click', async () => {
      const missing = [];
      if (!getValue('propertyAddress')) missing.push("Eign");
      if (!getValue('sellerName') || !getValue('sellerSSN')) missing.push("Seljandi (nafn/kt)");
      if (!getValue('buyerName')  || !getValue('buyerSSN'))  missing.push("Kaupandi (nafn/kt)");
      if (missing.length) { alert("Vantar: " + missing.join(", ")); return; }

      const { Document, Packer, Paragraph, HeadingLevel, TextRun } = docx;
      const doc = new Document({
        sections: [{
          children: [
            new Paragraph({ text: "Beiðni um skilyrt veðleyfi", heading: HeadingLevel.HEADING_1 }),
            new Paragraph(" "),
            new Paragraph(new TextRun({ text: "Mál:", bold: true })),
            new Paragraph(`Eign: ${getValue('propertyAddress')} (FN: ${getValue('propertyId')})`),
            new Paragraph(`Seljandi: ${getValue('sellerName')} kt. ${getValue('sellerSSN')}`),
            new Paragraph(`Kaupandi: ${getValue('buyerName')} kt. ${getValue('buyerSSN')}`),
            new Paragraph(" "),
            new Paragraph(new TextRun({ text: "Beiðni:", bold: true })),
            new Paragraph("Óskað er eftir skilyrtu veðleyfi þar sem samþykkt er að veð skuldbindingar haldi gildi sínu eða færist samkvæmt samkomulagi, að því gefnu að skilyrði uppgjörs og veðflutnings séu uppfyllt við afsal."),
            new Paragraph(" "),
            new Paragraph(new TextRun({ text: "Forsendur:", bold: true })),
            new Paragraph(`Kaupverð: ${getValue('price')} | Trygging/útborgun: ${getValue('deposit')}`),
            new Paragraph(`Áætluð afhending: ${getValue('handover')}`),
            new Paragraph(`Sérákvæði/fyrirvarar: ${getValue('conditions')}`),
            new Paragraph(`Útgáfudagur afsals: ${getValue('deedIssueDate') || "(sjá greiðslutilhögun/við uppgjör)"}`),
            new Paragraph(" "),
            new Paragraph(new TextRun({ text: "Staðfesting:", bold: true })),
            new Paragraph("Staðfest að ofangreind gögn séu rétt og að veðleyfið verði aðeins virkjað ef skilyrði samnings og lögskilauppgjörs eru uppfyllt."),
            new Paragraph(" "),
            new Paragraph("___________________________    ___________________________"),
            new Paragraph("Dags.                                    Undirskrift"),
          ]
        }]
      });
      const blob = await Packer.toBlob(doc);
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob); a.download = "vedleyfisbeidni.docx"; a.click(); URL.revokeObjectURL(a.href);
    });

    console.log("Single-file demo loaded");
  });
  </script>
</body>
</html>
